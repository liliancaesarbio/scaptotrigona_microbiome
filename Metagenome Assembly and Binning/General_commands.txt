#### HERE YOU WILL FIND AN OVERVIEW OF COMMANDS USED. CUSTUM SCRIPTS ARE IN INDIVIDUAL FILES IN THIS SAME FOLDER.

## 28 shotgun metagenome samples
(SBBP1_FOOD SBBP1_FORAGER SBBP1_GUARD SBBP1_HONEY SBBP1_LARVAE SBBP1_NURSE SBBP1_POLLEN)
(SBBP2_FOOD SBBP2_FORAGER SBBP2_GUARD SBBP2_HONEY SBBP2_LARVAE SBBP2_NURSE SBBP4_POLLEN)
(SDBP2_HONEY SDBP3_FOOD SDBP3_FORAGER SDBP3_GUARD SDBP3_LARVAE SDBP3_NURSE SDBP3_POLLEN)
(SDBP4_FOOD SDBP4_FORAGER SDBP4_GUARD SDBP4_HONEY SDBP4_LARVAE SDBP4_NURSE SDBP4_POLLEN)


## Assembly
reads=/path
sample=(samples)

for sample in ${sample[*]}; do
        spades.py --meta -t 24 --pe1-1 $reads/${sample}*_R1_001.fastq.gz --pe1-2 $reads/${sample}*_R2_001.fastq.gz -o ${sample}_metaspades
done


## Mapping
for sample in ${sample[*]}; do
        cd ${sample}_metaspades
        bowtie2-build contigs.fasta contigs

        bowtie2 -x contigs -p 24 --no-discordant --no-mixed -1 $reads/${sample}*_R1_001.fastq.gz -2 $reads/${sample}*_R2_001.fastq.gz -S contigs.sam

        samtools view -Sb contigs.sam > contigs.bam
        samtools sort contigs.bam > contigs_sorted.bam
        rm contigs.sam
        cd ..
done


## Binning
for sample in ${sample[*]}; do
        mkdir ${sample}_bins
        cd ${sample}_bins

        jgi_summarize_bam_contig_depths --outputDepth ${sample}_depth.txt /path/${sample}_metaspades/contigs_sorted.bam
        metabat2 -t 24 -m 1500 -i /path/${sample}_metaspades/contigs.fasta -a ${sample}_depth.txt -o bins_${sample}   
        cd ..
done


## Check bin quality
for sample in ${sample[*]}; do
        checkm lineage_wf -t 12 --reduced_tree -x fa ../${sample}_bins/ checkm_${sample}/ --tab_table -f checkm_result_${sample}.tsv
        rm -r checkm_${sample}
done


## Use only contigs >1500 bp
for sample in ${sample[*]}; do
	cd ${sample}
	perl get_contigs_lenght.pl 1500 contigs.fasta > contigs1500.fasta
	cd ..
done



## Get contigs from the list
python get_seqs_from_list.py bigfile.fasta id_list


## Dereplicate bins
dRep dereplicate derepl_output -g *fa -d -l 1000 --S_algorithm skani --ignoreGenomeQuality --P_ani 0.95 --S_ani 0.95 --cov_thresh 0.85 -p 24 > outdrepbac1 2> errdrepbac1


## Check dereplicated bin quality
for sample in ${sample[*]}; do
        checkm lineage_wf -t 12 --reduced_tree -x fa ../${sample}_bins/ checkm_${sample}/ --tab_table -f checkm_result_${sample}.tsv
        rm -r checkm_${sample}
done


## Check if there is any good fungal bin
busco -i bins*.fa -l /path/fungi_odb10 -o busco_output -c 24 -m genome


## Coverage of each bin
for sample in ${sample[*]}; do
		bowtie2 -x contigs -p 24 --no-discordant --no-mixed -1 $reads/${sample}*_R1_001.fastq.gz -2 $reads/${sample}*_R2_001.fastq.gz -S ${sample}.sam

        samtools view -Sb ${sample}.sam > ${sample}.bam
        samtools sort ${sample}.bam > ${sample}_sorted.bam
        samtools index ${sample}_sorted.bam
        samtools depth -a ${sample}_sorted.bam > ${sample}_depthbins.txt
        samtools idxstats ${sample}_sorted.bam > ${sample}_statsbins.txt
        rm ${sample}.sam ${sample}.bam
done





